/* Example code for using the table cuts mechanism of dsu. */
#include <stdio.h>
#include "/afs/rhic/star/starlib/ref/sys/dsl/inc/dstype.h"
#include "/afs/rhic/star/starlib/ref/sys/dsl/inc/dsxdr.h"
typedef int myBool;
DS_DATASET_T *gPtr=NULL;
long gRows;
char *gHurdygurdy;
#define NBYTES 10000
/***********************************************************  FUNCTIONS  **/
void Uerror(int x) {
  printf("There is a fatal cuts error.  Number %d.\n",x); exit(2);
}
void CreateDsPointer(char *fn,FILE **ff,XDR *xdr,DS_DATASET_T **dsPtr) {
  if ((*ff = fopen(fn, "rb")) == NULL) {
    printf("I cannot read \"%s\".  This should be a xdf file.\n",fn); exit(2);
  }
  xdrstdio_create(xdr, *ff, XDR_DECODE);
  if(!xdr_dataset(xdr,dsPtr)) Uerror(  3);
}
void Table(DS_DATASET_T *dsPtr) {
  myBool isDataset,isTable; size_t scr,numEntries,entryNumber; char *name;
  char ans[5];
  DS_DATASET_T *local;
  if(!dsIsDataset(&isDataset,dsPtr))            Uerror(  4);
  if(!dsIsTable(&isTable,dsPtr))                Uerror(  5);
  if( isDataset&& isTable)                      Uerror(  1);
  if(!isDataset&&!isTable)                      Uerror(  2);
  if(isDataset) if(!dsDatasetName(&name,dsPtr)) Uerror(  9);
  if(isTable)   if(!dsTableName(&name,dsPtr))   Uerror( 10);
  if(isTable&&!gPtr) {
    printf("Do you want to use the table named \"%s\"? ",name);  gets(ans);
    if(*ans=='y') gPtr=dsPtr;
  }
  if(isDataset) {
    printf("In dataset %s.\n",name);
    if(!dsDatasetEntryCount(&numEntries,dsPtr)) Uerror(  8);
    for(entryNumber=0;entryNumber<numEntries;entryNumber++) {
      if(!dsDatasetEntry(&local,dsPtr,entryNumber)) Uerror(  6);
      Table(local); /* recursive */
    }
  }
}
void Usage(char *argv) {
  printf("Usage:    %s myfile.xdf cutsString\n",argv);
  printf("Example:  %s hier.xdf id>=3.and.id<=9\n",argv);
  exit(2);
}
void DoTheRecipe(void) {
  char ba[NBYTES]; size_t jj,rowIndex,nBytes;
  if(!dsTableRowCount(&nBytes,gPtr)) Uerror(111);
  printf("The number of rows is %d.\n",nBytes);
  gRows=nBytes;
  if(nBytes/8>NBYTES-2) Uerror(112);
  printf("Above dsuDoCuts\n");
  if(!dsuDoCuts(NBYTES,ba,gHurdygurdy,gPtr)) Uerror(113);
  printf("Below dsuDoCuts\n");
  for(jj=0;jj<nBytes;jj++) {
    if(dsuRowPassedCuts(ba,jj)) printf("Row %d passed cuts.\n",jj+1);
  }
}
void main(argc,argv) int argc; char **argv; {
  FILE *stream; XDR xdr; DS_DATASET_T *dsPtr=NULL;
  if(argc!=3) Usage((char*)argv[0]);
  gHurdygurdy=argv[2];
  CreateDsPointer(argv[1],&stream,&xdr,&dsPtr);
  printf("The ds pointer is %p.\n",dsPtr);
  gPtr=NULL;
  Table(dsPtr);
  if(gPtr==NULL) { printf("No selection.\n"); exit(2); }
  fclose(stream);
  DoTheRecipe();
  return;
}
