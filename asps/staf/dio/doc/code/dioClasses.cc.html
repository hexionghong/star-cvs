<HTML>
<PRE>
<H2>file: dio/src/dioClasses.cc</H2>


//:Copyright 1995, Lawrence Berkeley National Laboratory
//:&gt;--------------------------------------------------------------------
//:FILE:        dioClasses.C
//:DESCRIPTION: <A HREF="dio_macros.h.html#DIO">DIO</A> Classes
//:AUTHOR:      cet - Craig E. Tull, cetull@lbl.gov
//:BUGS:        -- STILL IN DEVELOPMENT --
//:HISTORY:     12dec95-v000a-cet- creation
//:&lt;--------------------------------------------------------------------

//:----------------------------------------------- INCLUDES           --
#include &lt;string.h&gt;
#include "asuAlloc.h"
#include "<A HREF="dioClasses.hh.html">dioClasses.hh</A>"

//:----------------------------------------------- MACROS             --
#include "<A HREF="dio_macros.h.html">dio_macros.h</A>"

//:=============================================== CLASS              ==
// dioFileStream

//:----------------------------------------------- CTORS & DTOR       --
<B>dioFileStream:: <A NAME="dioFileStream">dioFileStream(</A>const char * name)</B>
		: socObject(name, "dioFileStream") {
   myPtr = (SOC_PTR_T)this;
   myMode = DIO_UNKNOWN_MODE;
   myState = DIO_UNKNOWN_STATE;
}

//----------------------------------
<B>dioFileStream:: ~<A NAME="dioFileStream">dioFileStream(</A>) { }</B>

//:----------------------------------------------- ATTRIBUTES         --
<B><A HREF="dio_types.h.html#DIO_MODE_T">DIO_MODE_T</A> dioFileStream::  <A NAME="mode">mode</A> () {</B>
   return myMode;
}

//----------------------------------
<B><A HREF="dio_types.h.html#DIO_STATE_T">DIO_STATE_T</A> dioFileStream::  <A NAME="state">state</A> () {</B>
   return myState;
}

//:----------------------------------------------- PUB FUNCTIONS      --
<B>STAFCV_T dioFileStream:: <A NAME="close">close</A> () {</B>

   <A HREF="dio_types.h.html#DIO_STATE_T">DIO_STATE_T</A> saveState=myState;

/*- Close file and destroy xdr. -*/
   if( &myXDR != NULL ) XDR_DESTROY(&myXDR);
   fclose(myFile);

   myState = DIO_CLOSE_STATE;
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFileStream:: <A NAME="getEvent">getEvent</A> (const char * path ) {</B>

   <A HREF="dio_types.h.html#DIO_STATE_T">DIO_STATE_T</A> saveState=myState;

   if( !(DIO_OPEN_STATE == myState)
   ||  !(DIO_READ_MODE == myMode || DIO_UPDATE_MODE == myMode)
   ){
      EML_ERROR(BAD_MODE_OR_STATE);
   }
   myState = DIO_READ_STATE;
/*##########
   char * here;
   if( !dui-&gt;pwd(here)
   ||  !dui-&gt;cd(path)
   ){
      myState = saveState;
      EML_ERROR(HACK_BROKEN);
   }
##########*/

//- Read data here -**
DS_DATASET_T *pDS=NULL;
bool_t result;
   if( !xdr_dataset(&myXDR, &pDS)
   ||  !dsIsDataset(&result,pDS)
   ||  !result
   ||  !<A HREF="dio_utils.cc.html#dio_addHierarchy">dio_addHierarchy(</A>dui_pDScwd,pDS)
   ){
//    dui-&gt;cd(here);
      myState = saveState;
      EML_ERROR(CANT_READ_FROM_STREAM);
   }

/*&&&&&&&&&&
   dui-&gt;cd(here);
&&&&&&&&&&*/
   myState = saveState;
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFileStream:: <A NAME="open">open</A> (const char * fileName, <A HREF="dio_types.h.html#DIO_MODE_T">DIO_MODE_T</A> <A HREF="#mode">mode</A>) {</B>

   xdr_op xdr_mode;
   char* fo_mode="rb";

//- Set XDR & fopen modes -**
   switch (<A HREF="#mode">mode</A>){
   case DIO_READ_MODE:
      xdr_mode = XDR_DECODE;
      strcpy(fo_mode,"rb");
      break;
   case DIO_WRITE_MODE:
      xdr_mode = XDR_ENCODE;
      strcpy(fo_mode,"wb");
      break;
   case DIO_UPDATE_MODE:	// Update not yet implimented
   case DIO_UNKNOWN_MODE:
   default:
      EML_ERROR(INVALID_MODE);
      break;
   }

//- Open file. -**
   if( (myFile = fopen(fileName, fo_mode)) == NULL ){
      EML_ERROR(CANT_OPEN_FILE);
   }

//- Create XDR pointer. -**
   xdrstdio_create(&myXDR, myFile, xdr_mode);
//-? if( myXDR == NULL ) EML_ERROR(BAD_XDR); -??

   myMode = <A HREF="#mode">mode</A>;
   myState = DIO_OPEN_STATE;
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFileStream:: <A NAME="putEvent">putEvent</A> (const char * path ){</B>
   if( !(DIO_OPEN_STATE == myState)
   ||  !(DIO_WRITE_MODE == myMode || DIO_UPDATE_MODE == myMode)
   ){
      EML_ERROR(BAD_MODE_OR_STATE);
   }
   myState = DIO_WRITE_STATE;
/*%%%%%%%%%%
   tdmDataset *dataset;
   if( !tdm-&gt;findDataset(path,dataset) ){
      EML_ERROR(TDMDATASET_NOT_FOUND);
   }

...WORK WORK WORK WORK WORK WORK WORK WORK

   char * here;
   if( !dui-&gt;pwd(here)
   ||  !dui-&gt;cd(path)
   ){
      myState = DIO_OPEN_STATE;
      EML_ERROR(HACK_BROKEN);
   }
%%%%%%%%%%*/

//- Write data here -**
   if( !xdr_dataset(&myXDR, &dui_pDScwd) ){
      myState = DIO_OPEN_STATE;
      EML_ERROR(ERROR_WRITING_DATASET);
   }

// dui-&gt;cd(here);
   myState = DIO_OPEN_STATE;
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//:----------------------------------------------- PRIV FUNCTIONS     --
// **NONE**

// ---------------------------------------------------------------------

//:=============================================== CLASS              ==
// dioFactory

//:----------------------------------------------- CTORS & DTOR       --
<B>dioFactory:: <A NAME="dioFactory">dioFactory(</A>const char * name)</B>
		: socFactory()
		, socObject(name, "dioFactory") {
   myPtr = (SOC_PTR_T)this;
   lock(TRUE);
}

//----------------------------------
<B>dioFactory:: ~<A NAME="dioFactory">dioFactory(</A>) {</B>
}

//:----------------------------------------------- ATTRIBUTES         --
//:**NONE**

//:----------------------------------------------- PUB FUNCTIONS      --
<B>STAFCV_T dioFactory:: <A NAME="deleteFileStream">deleteFileStream</A> (const char * name ){</B>
   if( !soc-&gt;deleteObject(name,"dioFileStream") ){
      EML_ERROR(CANT_DELETE_OBJECT);
   }
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFactory:: <A NAME="findFileStream">findFileStream</A> (const char * name</B>
		, dioFileStream*& fileStream ){
   socObject* obj;
   if( !soc-&gt;findObject(name,"dioFileStream",obj) ){
      fileStream = NULL;
      EML_ERROR(OBJECT_NOT_FOUND);
   }
   fileStream = <A HREF="dio_macros.h.html#DIOFILESTREAM">DIOFILESTREAM(</A>obj);
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFactory:: <A NAME="getFileStream">getFileStream</A> (IDREF_T id</B>
		, dioFileStream*& fileStream ){
   socObject* obj;
   if( !soc-&gt;getObject(id,obj) ){
      fileStream = NULL;
      EML_ERROR(OBJECT_NOT_FOUND);
   }
   if( 0 != strcmp(obj-&gt;type(),"dioFileStream") ){
      fileStream = NULL;
      EML_ERROR(WRONG_OBJECT_TYPE);
   }
   fileStream = <A HREF="dio_macros.h.html#DIOFILESTREAM">DIOFILESTREAM(</A>obj);
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFactory:: <A NAME="list">list</A> (){</B>
   socObject* obj;

   printf("\n"
"**********************************************************************"
   "\n"
"***************** <A HREF="dio_macros.h.html#DIO">DIO</A> - Dataset Input/Output listing *****************"
   "\n"
"**********************************************************************"
   "\n"
"* IDREF * NAME            * TYPE            * MODE & STATE            "
   "\n"
"**********************************************************************"
    "\n");
   for( int i=0;i&lt;count();i++ ){
      if( soc-&gt;getObject(entry(i),obj) ){
         if( 0 == strcmp("dioFileStream",obj-&gt;type()) ){
            printf("* %5d * %-15s * %-15s * %s %s \n"
                        ,obj-&gt;idRef(),obj-&gt;name(),obj-&gt;type()
			, <A HREF="dio_utils.cc.html#dio_mode2text">dio_mode2text(</A><A HREF="dio_macros.h.html#DIOFILESTREAM">DIOFILESTREAM(</A>obj)-&gt;<A HREF="#mode">mode</A>())
			, <A HREF="dio_utils.cc.html#dio_state2text">dio_state2text(</A><A HREF="dio_macros.h.html#DIOFILESTREAM">DIOFILESTREAM(</A>obj)-&gt;<A HREF="#state">state</A>())
                        );
         } else if( 0 == strcmp("dioTestStream",obj-&gt;type()) ){
            printf("* %5d * %-15s * %-15s * \n"
                        ,obj-&gt;idRef(),obj-&gt;name(),obj-&gt;type()
                        );
         }
      } else {
         printf("* %5d * %-15s * %-15s * \n"
                        ,entry(i),"**DELETED**","**DELETED**");
      }
   }
   printf(
"**********************************************************************"
   "\n\n");

   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);
}

//----------------------------------
<B>STAFCV_T dioFactory:: <A NAME="newFileStream">newFileStream</A> (const char * name</B>
		, const char * fileName, <A HREF="dio_types.h.html#DIO_MODE_T">DIO_MODE_T</A> <A HREF="#mode">mode</A> ){
   IDREF_T id;
   if( soc-&gt;idObject(name,"dioFileStream",id) ){
      EML_ERROR(DUPLICATE_OBJECT_NAME);
   }
   static dioFileStream* p;
   p = new <U>dioFileStream(</U>name);        //OVERLOAD CALL: dioFileStream: <A HREF="dioClasses.cc.html#dioFileStream">dioClasses.cc(?)</A>, <A HREF="dioClasses.cc.html#dioFileStream">dioClasses.cc(?)</A>
   if( !soc-&gt;idObject(name,"dioFileStream",id) ){
      EML_ERROR(OBJECT_NOT_FOUND);
   }
   addEntry(id);
   if( !p-&gt;<A HREF="#open">open</A>(fileName,<A HREF="#mode">mode</A>) ){
      p-&gt;<A HREF="#close">close</A>();
      soc-&gt;deleteObject(name,"dioFileStream");
      EML_ERROR(CANT_OPEN_FILE);
   }
   EML_SUCCESS(NORMAL_SUCCESSFUL_COMPLETION);

}

//:----------------------------------------------- PRIV FUNCTIONS     --

// ---------------------------------------------------------------------

<P>
<P>
<HR>
<H2>Back to <A HREF="files.html">Source File Index</A></H2><P>
<P><HR>
<H5>C++ to HTML Conversion by <I><A HREF="http://www.usc.edu/dept/robotics/personal/af0a/tools/ctoohtml/ctoohtml.html">ctoohtml</A></I></H5>
















































</PRE>
</HTML>
