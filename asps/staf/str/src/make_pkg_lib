#!/bin/csh
#
# make_pkg_lib "makes" an object library for a software package pkg
#
# pkg is taken from the directory name one level above the current
# directory
#
#  Created: 8-Jan-1993   D. Olson
#
#  Modified 22-Mar-1993  R. Hackenburg, for the str package.  Uses str's
#                        local Makefile, invoked with "make -e all" from here.
#                        Added *_DBG definitions, flags, etc.  Libraries are
#                        produced here in two flavors, debug and nodebug.
#
#
echo "Start rebuilding library at `date` for architecture $STAR_ARCH"
echo "This is the personalized str version of make_pkg_lib."
#
#
#
if ("`alias rm `" == "rm -i") then
   unalias rm
endif
if ("`alias mv `" == "mv -i") then
   unalias mv
endif
#
if ( "$STAR_ARCH" == "sun4" ) then
   set ARFLAGS     = ( lqv )
   set FFLAGS      = ( -xl -e -c )
   set FFLAGS_DBG  = ( -xl -e -c -g )
   set CCFLAGS     = ( -c -D SUN -I ../inc )
   set CCFLAGS_DBG = ( -c -g -D SUN -I ../inc )
else if ( "$STAR_ARCH" == "hpux" ) then
   set ARFLAGS     = ( lqv )
   set FFLAGS      = ( +e +es -c +ppu )
   set FFLAGS_DBG  = ( +e +es -c -g +ppu )
   set CCFLAGS     = ( -c -D HPUX -I ../inc )
   set CCFLAGS_DBG = ( -c -g -D HPUX -I ../inc )
else if ( "$STAR_ARCH" == "irix" ) then
   set ARFLAGS     = ( slqv )
   set FFLAGS      = ( -extend_source -c -O -w )
   set FFLAGS_DBG  = ( -extend_source -c -g -w )
   set CCFLAGS     = ( -c -O -w -DIRIX -I../inc )
   set CCFLAGS_DBG = ( -c -g -w -DIRIX -I../inc )
#
#  INCLUDES under irix require this step...
#
   cd ../src
endif
if( -e make_flags.csh ) then
	source ../lib/make_flags.csh
endif
#
if( $1 == "" ) then
        set PKG = ( `(pwd | awk -F/ '{i=NF-1;print $i}')` )
else
        set PKG = ( $1 )
endif
#
echo "Will make library for package $PKG"
set OBJLIB     = ( ../lib/$STAR_ARCH/lib$PKG.a )
echo "Will make library for package ${PKG}_dbg"
set OBJLIB_DBG = ( ../lib/$STAR_ARCH/lib${PKG}_dbg.a )
#
if ( -e $OBJLIB ) then
	echo "Removing $OBJLIB"
	rm -f $OBJLIB
endif
#
if ( -e $OBJLIB_DBG ) then
	echo "Removing $OBJLIB_DBG"
	rm -f $OBJLIB_DBG
endif
#
#set OBJFILES = ( $STAR_ARCH/*.o )
#if( $OBJFILES == "" ) then
#	echo "No objects to remove"
#else
	echo "Removing all object files"
	rm -f ../lib/$STAR_ARCH/*.o
#endif
#
echo "Setting up include file links."
#D.O. 8-Mar-93rmlink *
#set INCFILES = ( ../inc/*.inc )
#if ( $INCFILES == "" ) then
# echo "No .inc files in ../inc
#else
	gen_include_dir_names ../inc
#endif
gen_include_dir_names ../src
if( $PKG != "tas" ) then
	gen_include_dir_names $STAR_ROOT/$STAR_LEVEL/sys/tas/inc
endif
#
echo "Executing '"make -e all"' on ../src"
echo "f77 flags are $FFLAGS and f77 debug flags are $FFLAGS_DBG"
echo "cc  flags are $CCFLAGS and cc debug flags are $CCFLAGS_DBG"
# Define this for the str makefile:
set  MSG = ../../msg/lib/$STAR_ARCH
cd ../src
make -e all
echo "Moving all .a files to ../lib/$STAR_ARCH"
mv *.a ../lib/$STAR_ARCH
echo "Removing all .o files"
rm -f *.o
#
echo "cleaning up include file links.."
rmlink *
#
echo "Done at `date`"






