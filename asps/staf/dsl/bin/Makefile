#cet(3/22/94)try at rsgi01.rhic.bnl.gov
#cet(3/8/94)#BASE_PATH=../13aug93
#
BASE_PATH=..
CPATH= . $(BASE_PATH)/src
HPATH= . $(BASE_PATH)/inc
LPATH= . $(BASE_PATH)/lib/$(STAR_ARCH)
OPATH= . $(BASE_PATH)/lib/$(STAR_ARCH) $(BASE_PATH)/bin/$(STAR_ARCH)
#
vpath %.c $(CPATH)
vpath %.h $(HPATH)
vpath %.a $(LPATH)
vpath %.o $(OPATH)
#
LIB=libds.a
LIBFILES=dserror.c dslib.c dstid.c dstree.c dslock.c\
	dstype.c dsutil.c dsxdrlib.c
TESTOBJ=checklib.o testlib.o testtas.o
LIBOBJ=$(patsubst %.c,%.o, $(LIBFILES)) $(TESTOBJ)
PROGOBJ=sample.o testds.o
PROGS=$(basename $(PROGOBJ))
OBJ=$(LIBOBJ) $(PROGOBJ)
#
CC=gcc
CPPFLAGS= $(patsubst %, -I%, $(HPATH))
# CFLAGS=-DFORCE_FULL_XDR -Wall
CFLAGS= -Wall
CC68K=cc68k
LD68K=ld68k
VWLIB=dsdlib.68o
VWOBJ=$(patsubst %.o, %.68o, $(LIBOBJ)) 
CC68FLAGS=  -DCPU=MC68040 -DVXWORKS -I$(VX_VW_BASE)/h $(CPPFLAGS) -Wall

# all:		progs vwlib

progs:		$(PROGS)
	mv $(PROGS) ./$(STAR_ARCH)/.
#	foreach f ($(PROGS))
#	   mv $$f ./irix/.
#	 end

vwlib:		$(VWLIB)

$(PROGS):	$(LIB)

$(OBJ) : dscodes.h dstype.h

dsxdrlib.o $(TESTOBJ) $(PROGOBJ) : dsxdr.h

checklib.o sample.o : sample.h

dscodes.h:	stamp-dscodes ; @true

stamp-dscodes:	tmp-dscodes.h
		if cmp -s tmp-dscodes.h dscodes.h ; then\
			echo dscodes.h not changed ; else \
			cp tmp-dscodes.h dscodes.h; fi
		touch stamp-dscodes

tmp-dscodes.h:	$(LIBFILES)
		echo "	/* tmp-dscodes.h - GENERATED BY MAKE - DO NOT EDIT */"\
			>tmp-dscodes.h
		echo "#ifndef DSCODES_H" >>tmp-dscodes.h
		echo "#define DSCODES_H" >>tmp-dscodes.h
		echo "typedef enum ds_codes_t {" >>tmp-dscodes.h
		echo "	DS_E_OK = 0," >>tmp-dscodes.h
		grep "_ERROR(DS_E_"  $^ |\
		sed -e 's/.*(/	/p' |\
		sed -e 's/).*/,/' |\
		sort -u |grep -v DS_E_OK >>tmp-dscodes.h
		echo "	DS_E_CODE_COUNT" >>tmp-dscodes.h
		echo "}DS_CODES_T;" >>tmp-dscodes.h
		echo "#endif /* DSCODES_H */" >>tmp-dscodes.h

%.68o : %.c
		$(CC68K) $(CC68FLAGS) -c $< -o $@

$(VWLIB):	$(VWOBJ)
		$(LD68K) -r -o $(VWLIB) $(VWOBJ)

$(LIB):		$(LIBOBJ)
		ar r $@ $?
		-ranlib $@

install:	$(LIB)
		cp -p $(LIB) ../lib

cleancodes:
		-rm stamp-dscodes dscodes.h tmp-dscodes.h

clean:		cleancodes
		-rm $(LIB) $(OBJ) $(PROGS) $(VWLIB) $(VWOBJ) xtest.bin
